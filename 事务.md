# 事务

## 什么是事务

​	指要做的事，或者是正在做的事。我们通常指对数据库数据的操作。一个事务包含一条或条 sql 语句，每一块 sql 语句的执行为一次事务，每个事务的执行状态要么成功，要么失败。

![事务的生命周期](D:\Java\笔记\事务的生命周期.png)

## 	

## 特性（ACID）：

### 		1、原子性 (atomicity)：

```txt
	事务被作为一个最小单元，不可再对其划分，也就是说如果事务中包含多条 sql 语句，那么这些 sql 语句被当作一个整体，不应该被外界所影响，其中一条语句执行失败都会使得整个事务回滚到为未执行状态。
```

### 		2、一致性 (consistency)：

```
	事务执行前后，保证前后数据没有破坏数据库的约束，以此保证数据约束的一致性。若未达到一致性原则，事务将会被回滚到一致性状态中。一致性发生在同一数据库的多个事务之后。
```

### 		3、隔离性 (Isolation)：

```
	多个事务之间是相互独立的，在事务并发执行时，事务与事务之间互不干扰。
```

### 		4、持久性 (Durability)：

```
	事务进行提交操作以后，操作后的数据会永久保存在数据库中。
```

### 		事务的隔离级别

​				事务的并发会对同一数据操作产生异常情况：

#### 				1、脏读：

​							一个事务读取到另一个事务中修改但并未提交操作的数据。

#### 				2、幻读：

​							一个事务对一行数据进行修改操作时，另一个事务同时对该行数据的另一个字段进行修改操作。					两个事务完成修改后执行查询操作时，读到自己未操作过的数据，如同幻觉一样，称为幻读。不同于				    脏读的是，先修改后查询，出现事务中未操作的数据被修改。

#### 			     3、不可重复读：

​							一个事务中对同一个表数据进行多次查询，二次查询中出现一次查询中未出现的数据，多次查询					读到的数据不重复相同，称为不可重复读。原因是在查询过程中，另一个事务发生，对该表数据进行					了修改操作，导致二次查询出新数据。

#### 				 4、丢失修改：

​							多个事务对同一个数据进行修改操作，其中已提交事务被回滚事务一同撤销，导致修改未执					行。

​							多个并发事务同时对同一个数据进行修改操作，导致其中一个事务写操作失败。

### 		事务的隔离：				

​					为了规范事务的隔离性，数据库设置了4个事务的隔离级别：

#### 					1、读未提交：

​								最低级别，可以读取未提交的事务修改操作。即允许所有情况发生。

#### 					2、读已提交

​								Oracle 默认级别， 不允许脏读情况发生。

#### 					3、可重复读：

​								mysql 默认级别，不允许脏读、不可重复读，但会出现幻读。

#### 					4、串行读：

​								 最高隔离级别，使事务不可并发发生，对同一数据库每次只允许一个事务发生，其他事务等						 待，无论读写操作。当每次数据库操作中只有一个事务发生时，就不会出现事务的不一致性。但是						 事务效率会极大的降低

### 		事务锁

​					为了能提高各个级别的事务效率，预防并发操作异常，锁的设计应景而出：

#### 					1、共享锁 （S 锁）：

​								 用于只读操作，对共享表数据锁定更新操作，但不会锁定读操作。同一数据对象可以存在多个					    共享锁。

#### 					2、更新锁（U 锁）：

​								 用于可更新的表中，防止在并发读取、获取共享锁定后进行更新产生的死锁问题。当事务并						发查询后进行修改操作时，会获取共享锁，可能会出现两个事务同时获得共享锁，由于共享锁锁定						更新操作，一次只能有一个事务可以进行修改操作，此时两个事务都在等待对方释放锁，而造成死						锁结果。因为更新锁只允许存在一个，在事务中执行 update 时，为其分配一把更新锁，然后事务						等待上一个读取事务的结束，执行更新操作时，再升级为独占锁。加入更新锁可以避免死锁发生。

#### 					3、独占锁（X 锁，排他锁）：

​								事务完全独占资源，在该事务完成之前不允许其他任何读写事务的发生，不会发生死锁问题。

### 		 锁机制

![锁机制](D:\Java\笔记\锁机制.png)



## 事务用来做什么

​		事务的作用由其特性决定。在对数据库的操作中，为了能使数据被合理的读写，规范了事务的管理，有效并准确地进行数据库操作。



## 事务怎么用

### 1、在 spring 框架中，分为编程式事务管理和声明式事务管理。

​		

### 2、事务只是 sql 的集合，主要在于锁机制的使用对事务的管理。	

​		